rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===================================
    // Helper Functions
    // ===================================
    function signedIn() {
      return request.auth != null;
    }
    
    function isSystemAdmin() {
      return request.auth.uid == "oh3jF10Am4PPGelNzFhjWX6GE5E2";
    }

    function userExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function getProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function role() {
      return userExists() ? getProfile().role : '';
    }
    function dept() {
      return userExists() ? getProfile().department : '';
    }
    
    function isViewer() {
      return signedIn() && role() == "VIEWER";
    }

    function isAdmin() {
      return isSystemAdmin() || (signedIn() && role() == "ADMIN");
    }

    function isMgmt() {
      return isSystemAdmin() || (signedIn() && (dept() == "MANAGEMENT" || role() == "ADMIN" || role() == "MANAGER"));
    }
    
    function isOffice() {
      return signedIn() && (dept() == "OFFICE" || dept() == "MANAGEMENT") && !isViewer();
    }

    function isService() {
      return signedIn() && (dept() == "CAR_SERVICE" || dept() == "COMMONRAIL" || dept() == "MECHANIC") && !isViewer();
    }

    function canEditJobs() {
      return (isAdmin() || isMgmt() || isOffice() || isService()) && !isViewer();
    }
    
    function isOfficeOrMgmt() {
      return (isMgmt() || (signedIn() && (dept() == "OFFICE" || role() == "ADMIN" || role() == "MANAGER" || role() == "OFFICER"))) && !isViewer();
    }
    
    function isAccountingAllowed() {
      return isOfficeOrMgmt();
    }
    
    function hrSettings() {
      return get(/databases/$(database)/documents/settings/hr).data;
    }

    // ===================================
    // Default Security Rules
    // ===================================
    match /{document=**} {
      allow read: if signedIn();
      allow write: if isAdmin(); // System default fallback
    }

    // ===================================
    // Collection-Specific Rules
    // ===================================

    // User Profiles
    match /users/{uid} {
      allow read: if signedIn();
      allow create, update: if (isMgmt() || (signedIn() && request.auth.uid == uid)) && !isViewer();
      allow delete: if isAdmin();
    }

    // Settings
    match /settings/{docId} {
      allow read: if signedIn();
      allow write: if isMgmt();
    }

    // Cash Drawer
    match /cashDrawerSessions/{sessionId} {
      allow read: if signedIn();
      allow create, update: if isOfficeOrMgmt();
      allow delete: if isAdmin();
      
      match /transactions/{transId} {
        allow read: if signedIn();
        allow create: if isOfficeOrMgmt();
        allow update, delete: if isMgmt();
      }
    }

    // Customers & Vendors
    match /customers/{id} {
      allow read: if signedIn();
      allow create, update: if canEditJobs();
      allow delete: if isAdmin();
    }
    match /vendors/{id} {
      allow read: if signedIn();
      allow create, update: if canEditJobs();
      allow delete: if isAdmin();
    }

    // Jobs & Main Documents
    match /jobs/{jobId} {
      allow read: if signedIn();
      allow create: if signedIn() && !isViewer();
      allow update: if canEditJobs();
      allow delete: if isMgmt();
      match /activities/{activityId} {
        allow read: if signedIn();
        allow create: if signedIn() && !isViewer();
        allow update, delete: if canEditJobs();
      }
    }
    
    // Archive Collections
    match /{collectionName}/{jobId} {
        allow read: if signedIn() && collectionName.startsWith('jobsArchive_');
        allow create, update, delete: if isMgmt() && collectionName.startsWith('jobsArchive_');
        match /activities/{activityId} {
            allow read: if signedIn() && collectionName.startsWith('jobsArchive_');
            allow write: if isMgmt() && collectionName.startsWith('jobsArchive_');
        }
    }

    match /documents/{docId} {
      allow read: if signedIn();
      allow create: if signedIn() && !isViewer();
      allow update: if (isAccountingAllowed() || signedIn()) && !isViewer();
      allow delete: if isAdmin();
    }
    
    match /documentCounters/{yearId} {
      allow read: if signedIn();
      allow create, update: if signedIn() && !isViewer();
      allow delete: if isAdmin();
    }

    match /purchaseDocs/{docId} {
      allow read: if signedIn();
      allow create: if signedIn() && !isViewer();
      allow update: if signedIn() && !isViewer();
      allow delete: if isAdmin();
    }
    
    match /purchaseClaims/{claimId} {
        allow read, create, update: if isAccountingAllowed();
        allow delete: if isAdmin();
    }

    match /accountingAccounts/{id} {
      allow read, write: if isAccountingAllowed();
    }
    
    match /accountingEntries/{id} {
      allow read, create, update: if isAccountingAllowed();
      allow delete: if isMgmt();
    }
    
    match /accountingObligations/{id} {
      allow read, create, update: if signedIn() && !isViewer();
      allow delete: if isMgmt();
    }
    
    match /billingRuns/{monthId} {
        allow read, write: if isAccountingAllowed();
    }

    match /attendance/{id} { allow read, write: if signedIn(); }
    match /kioskTokens/{id} {
      allow read, create, update: if true;
      allow delete: if isAdmin(); 
    }
    
    match /hrHolidays/{id} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }
    
    match /hrAttendanceAdjustments/{id} {
      allow read: if isMgmt();
      allow write: if isAdmin();
    }
    
    match /ssoHospitals/{hospitalId} {
      allow read: if signedIn();
      allow write: if isMgmt();
    }
    
    match /hrLeaves/{id} {
        allow read: if isMgmt() || (signedIn() && request.auth.uid == resource.data.userId);
        allow create: if signedIn() && !isViewer();
        allow update: if (isMgmt() || (signedIn() && request.auth.uid == resource.data.userId)) && !isViewer();
        allow delete: if isAdmin();
    }

    match /payrollBatches/{batchId} {
      allow read, write: if isMgmt();
      match /payslips/{userId} {
        allow read: if (signedIn() && request.auth.uid == userId) || isMgmt();
        allow write: if (isMgmt() || (signedIn() && request.auth.uid == userId)) && !isViewer();
      }
    }

    match /quotationTemplates/{id} {
      allow read: if signedIn();
      allow write: if isOfficeOrMgmt();
    }
  }
}
