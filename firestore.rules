rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    // System admin fallback (กันล็อกตัวเอง)
    function isSystemAdmin() {
      return signedIn() && request.auth.token.email == "sahadieselkolkarn@gmail.com";
    }

    // Try custom claims first; fallback to common profile collections.
    function roleFromProfile() {
      return
        exists(/databases/$(database)/documents/userProfiles/$(request.auth.uid)) ? get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.role :
        exists(/databases/$(database)/documents/profiles/$(request.auth.uid)) ? get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role :
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role :
        null;
    }

    function deptFromProfile() {
      return
        exists(/databases/$(database)/documents/userProfiles/$(request.auth.uid)) ? get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.department :
        exists(/databases/$(database)/documents/profiles/$(request.auth.uid)) ? get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.department :
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.department :
        null;
    }

    function role() { return request.auth.token.role != null ? request.auth.token.role : roleFromProfile(); }
    function dept() { return request.auth.token.department != null ? request.auth.token.department : deptFromProfile(); }

    function isAdmin() { return isSystemAdmin() || (signedIn() && role() == "ADMIN"); }
    function isMgmt()  { return isAdmin() || (signedIn() && dept() == "MANAGEMENT"); }

    // ปรับชื่อแผนกการเงินให้ตรง constants ของโปรเจค ถ้ายังไม่มี ให้ MANAGEMENT ทำหน้าที่แทนไปก่อน
    function isFinance() {
      return isAdmin() || isMgmt() || (signedIn() && (dept() == "FINANCE" || dept() == "ACCOUNTING"));
    }

    // -------------------------
    // Default: readable (signed-in), writable: deny
    // This rule secures the database by default. Specific write rules must be explicitly defined below.
    // -------------------------
    match /{document=**} {
      allow read: if signedIn();
      allow write: if false;
    }

    // -------------------------
    // Profiles (if used)
    // Users can edit their own profiles. Admins can edit any.
    // -------------------------
    match /users/{uid} {
      allow read: if signedIn();
      allow create, update: if isAdmin() || (signedIn() && request.auth.uid == uid);
      allow delete: if isAdmin();
    }
     match /userProfiles/{uid} {
      allow read: if signedIn();
      allow create, update: if isAdmin() || (signedIn() && request.auth.uid == uid);
      allow delete: if isAdmin();
    }
    match /profiles/{uid} {
      allow read: if signedIn();
      allow create, update: if isAdmin() || (signedIn() && request.auth.uid == uid);
      allow delete: if isAdmin();
    }

    // -------------------------
    // Settings
    // Only Admins can change application-wide settings.
    // -------------------------
    match /settings/{docId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    // -------------------------
    // Customers / Vendors
    // -------------------------
    match /customers/{id} {
      allow read: if signedIn();
      allow create, update: if isAdmin() || isMgmt() || (signedIn() && dept() == "OFFICE");
      allow delete: if isAdmin();
    }
    match /vendors/{id} {
      allow read: if signedIn();
      allow create, update: if isAdmin() || isMgmt() || (signedIn() && dept() == "OFFICE");
      allow delete: if isAdmin();
    }

    // -------------------------
    // Jobs + subcollection activities
    // Any signed-in user can create/update jobs and activities to maintain workflow integrity.
    // Deletion is restricted to Admins.
    // -------------------------
    match /jobs/{jobId} {
      allow read: if signedIn();
      allow create, update: if signedIn();
      allow delete: if isAdmin();

      match /activities/{activityId} {
        allow read: if signedIn();
        allow create: if signedIn();
        allow update, delete: if isAdmin();
      }
    }

    // -------------------------
    // Documents + Counters
    // -------------------------
    match /documents/{docId} {
      allow read: if signedIn();

      // Office, Management, and Admins can create documents.
      allow create: if isAdmin() || isMgmt() || (signedIn() && dept() == "OFFICE");

      // Update rules:
      // - Drafts can be edited, but docNo is immutable after creation.
      // - Only financial roles can update payment status or financial fields.
      allow update: if (
        (resource.data.status == "DRAFT" && request.resource.data.docNo == resource.data.docNo)
        || isFinance() || isAdmin()
      );

      allow delete: if isAdmin();
    }

    match /documentCounters/{yearId} {
      // Allow writes for transactional document number generation.
      allow read, create, update: if signedIn();
      allow delete: if isAdmin();
    }

    // -------------------------
    // Payment Claims (Incoming Payment Verification)
    // -------------------------
    match /paymentClaims/{claimId} {
      // Only financial roles can view claims.
      allow read: if isFinance() || isAdmin();

      // Office can create claims when a customer pays.
      allow create: if signedIn() && dept() == "OFFICE";

      // Only financial roles can approve, reject, or update claims.
      allow update: if isFinance() || isAdmin();

      allow delete: if isAdmin();
    }

    // -------------------------
    // Core Accounting Collections
    // These collections are the source of truth for financials.
    // -------------------------
    match /accountingAccounts/{id} {
      allow read, create, update: if isFinance() || isAdmin();
      allow delete: if isAdmin();
    }

    match /accountingEntries/{id} {
      // Read access for financial roles.
      allow read: if isFinance() || isAdmin();
      // Creation is allowed for financial roles (e.g., manual cash-out).
      allow create: if isFinance() || isAdmin();
      // Entries are immutable for data integrity. Only Admins can override.
      allow update, delete: if isAdmin();
    }

    match /accountingObligations/{id} {
      allow read, create, update: if isFinance() || isAdmin();
      allow delete: if isAdmin();
    }
    
    // HR collections for leave and holidays.
    match /hrHolidays/{holidayId} {
      allow read: if signedIn();
      allow write: if isMgmt();
    }
    
    match /hrLeaves/{leaveId} {
      allow read: if signedIn();
      allow create: if request.auth.uid == request.resource.data.userId;
      allow update: if isMgmt() || (request.auth.uid == resource.data.userId && request.resource.data.status == "CANCELLED");
    }
    
    match /hrAttendanceAdjustments/{adjustmentId} {
      allow read: if signedIn();
      allow write: if isMgmt();
    }
    
    match /payrollRuns/{runId} {
      allow read, write: if isMgmt();
      match /payslips/{payslipId} {
        allow read: if isMgmt() || request.auth.uid == payslipId;
        allow write: if isMgmt() || (request.auth.uid == payslipId && request.resource.data.employeeStatus != resource.data.employeeStatus);
      }
    }
    
    // Attendance and Kiosk tokens
    match /attendance/{attendanceId} {
        allow read: if signedIn();
        allow create: if signedIn();
        allow write: if isMgmt();
    }
    
    match /kioskTokens/{tokenId} {
        allow read, write: if signedIn();
    }
  }
}
