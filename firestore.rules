/**
 * Core Philosophy:
 * This ruleset implements a Department-Based Access Control (DBAC) model for a
 * job management application. A user's permissions are primarily determined by
 * their 'department' and 'status' fields stored within their user profile document.
 * The 'MANAGEMENT' department has global administrative privileges. The default
 * posture is to deny all access, granting permissions only to authenticated
 * users with an 'ACTIVE' status in their respective departments.
 *
 * Data Structure:
 * The data is organized into three distinct top-level collections:
 * 1. /users/{userId}: Stores user profiles and serves as the source of truth
 *    for authorization decisions (department and status).
 * 2. /customers/{customerId}: A central repository for customer information.
 * 3. /jobs/{jobId}: Contains all job-related data.
 *
 * Key Security Decisions:
 * - Department-Based Access: All significant operations on /customers and /jobs
 *   require a get() call to the user's profile in /users to verify their
 *   department and status. This is necessary to implement DBAC.
 * - User Management: Only users from the 'MANAGEMENT' department can modify
 *   other user profiles, which is essential for managing departments and statuses.
 *   Regular users can only manage their own profiles. User listing is also
 *   restricted to 'MANAGEMENT'.
 * - Job Ownership: A job can be updated by a 'MANAGEMENT' user or by any
 *   active user within the job's assigned department. This provides both
 *   department-level control and administrative override capabilities.
 * - Default Secure: Unauthenticated users have no access. Users with a 'PENDING'
 *   status can only read their own profile and cannot interact with any other
 *   data.
 *
 * Denormalization for Authorization:
 * The `jobs` collection includes a denormalized `department` field, which is
 * central to the authorization model. Rules check this field against the
 * requesting user's department to grant or deny access.
 *
 * Structural Segregation:
 * The use of separate top-level collections for `users`, `customers`, and `jobs`
 * creates strong security boundaries. This allows for clear, independent rules
 * for each data type, preventing accidental permission leakage between them.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }
    
    /**
     * Checks if the user has an 'ACTIVE' status.
     */
    function isActiveUser() {
      return isSignedIn() && getUserData().status == 'ACTIVE';
    }

    /**
     * Checks if the requesting user's UID matches the provided userId.
     * This is the foundation of the document ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Retrieves the requesting user's profile data from the /users collection.
     * This is the core of the DBAC system, used to check department and status.
     * Note: This function results in a Firestore read operation.
     */
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    /**
     * Checks if the user is in the MANAGEMENT department.
     * This department has the highest level of privileges.
     */
    function isManagement() {
      return isActiveUser() && getUserData().department == 'MANAGEMENT';
    }

    /**
     * Checks if the user is authorized for office tasks (customer/job intake).
     * This aligns with the UI guard for the '/app/office' section.
     */
    function isOfficeUser() {
      return isActiveUser() && getUserData().department in ['MANAGEMENT', 'OFFICE'];
    }

    /**
     * Checks if the user is any active employee.
     * This is used for general access to shared resources like viewing jobs.
     */
    function isWorker() {
      return isActiveUser();
    }

    /**
     * Ensures an update operation does not change the document's unique ID.
     * This prevents re-associating a user profile with a different auth UID.
     */
    function isIdImmutable() {
      return request.resource.data.id == resource.data.id;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description
     *   Manages user profiles and their subcollections.
     */
    match /users/{userId} {
      /**
       * @description
       *   A user can create and manage their own profile.
       *   A 'MANAGEMENT' user can view and edit any user's profile to manage
       *   departments and status. Listing users is restricted to 'MANAGEMENT'.
       */
      allow get: if isOwner(userId) || isManagement();
      allow list: if isManagement();
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if (isOwner(userId) || isManagement()) && resource != null && isIdImmutable();
      allow delete: if false; // Deleting users should be handled via a managed process, not direct API calls.
      
      /**
       * @description
       *   Manages user time clock (attendance) records.
       */
      match /attendance/{attendanceId} {
        // An active user can create their own record, and management can read anyone's records.
        allow create: if isOwner(userId) && isActiveUser();
        allow read: if isOwner(userId) || isManagement();
        // No one can update or delete records directly to maintain data integrity.
        allow update, delete: if false;
      }
    }

    /**
     * @description
     *   Manages customer data. Only active 'OFFICE' or 'MANAGEMENT' users
     *   can access and create customer records. Only 'MANAGEMENT' can modify or
     *   delete existing customers to protect data integrity.
     */
    match /customers/{customerId} {
      allow get: if isOfficeUser();
      allow list: if isOfficeUser();
      allow create: if isOfficeUser();
      allow update: if isManagement() && resource != null;
      allow delete: if isManagement() && resource != null;
    }

    /**
     * @description
     *   Manages job records. Job creation is restricted to office staff.
     *   Any active employee can view the list of jobs. An existing job can only
     *   be updated by 'MANAGEMENT' or an active worker within the same department.
     *   Only 'MANAGEMENT' can delete jobs.
     */
    match /jobs/{jobId} {
      allow get: if isWorker();
      allow list: if isWorker();
      allow create: if isOfficeUser();
      allow update: if (isManagement() || (isWorker() && getUserData().department == resource.data.department)) && resource != null;
      allow delete: if isManagement() && resource != null;
    }
  }
}
