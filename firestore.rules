rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===================================
    // Helper Functions
    // ===================================
    function signedIn() {
      return request.auth != null;
    }
    
    function isSystemAdmin() {
      return request.auth.uid == "oh3jF10Am4PPGelNzFhjWX6GE5E2";
    }

    function userExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function getProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function role() {
      return userExists() ? getProfile().role : '';
    }
    function dept() {
      return userExists() ? getProfile().department : '';
    }
    
    function isAdmin() {
      return isSystemAdmin() || (signedIn() && role() == "ADMIN");
    }

    function isMgmt() {
      return isSystemAdmin() || (signedIn() && (dept() == "MANAGEMENT" || role() == "ADMIN" || role() == "MANAGER"));
    }
    
    function isOfficeOrMgmt() {
      return isMgmt() || (signedIn() && (dept() == "OFFICE" || role() == "ADMIN" || role() == "MANAGER"));
    }
    
    function isAccountingAllowed() {
      // Both Office and Management (including Manager/Admin) can manage accounting documents and entries
      return isOfficeOrMgmt();
    }
    
    function hrSettings() {
      return get(/databases/$(database)/documents/settings/hr).data;
    }

    // ===================================
    // Default Security Rules
    // ===================================
    match /{document=**} {
      allow read: if signedIn();
      allow write: if isAdmin(); // System default fallback
    }

    // ===================================
    // Collection-Specific Rules
    // ===================================

    // User Profiles
    match /users/{uid} {
      allow read: if signedIn();
      allow create, update: if isMgmt() || (signedIn() && request.auth.uid == uid);
      allow delete: if isAdmin();
    }

    // Settings
    match /settings/{docId} {
      allow read: if signedIn();
      allow write: if isMgmt();
    }

    // Cash Drawer
    match /cashDrawerSessions/{sessionId} {
      allow read: if signedIn();
      allow create, update: if isOfficeOrMgmt();
      allow delete: if isAdmin();
      
      match /transactions/{transId} {
        allow read: if signedIn();
        allow create: if isOfficeOrMgmt();
        allow update, delete: if isMgmt();
      }
    }

    // Customers & Vendors
    match /customers/{id} {
      allow read: if signedIn();
      allow create, update: if signedIn();
      allow delete: if isAdmin();
    }
    match /vendors/{id} {
      allow read: if signedIn();
      allow create, update: if signedIn();
      allow delete: if isAdmin();
    }

    // Jobs & Main Documents
    match /jobs/{jobId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if isMgmt();
      match /activities/{activityId} {
        allow read: if signedIn();
        allow create: if signedIn();
        allow update, delete: if isMgmt();
      }
    }
    
    // Archive Collections
    match /{collectionName}/{jobId} {
        allow read: if signedIn() && collectionName.startsWith('jobsArchive_');
        allow create, update, delete: if isMgmt() && collectionName.startsWith('jobsArchive_');
        match /activities/{activityId} {
            allow read: if signedIn() && collectionName.startsWith('jobsArchive_');
            allow write: if isMgmt() && collectionName.startsWith('jobsArchive_');
        }
    }

    match /documents/{docId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if isAccountingAllowed() || signedIn();
      allow delete: if isAdmin();
    }
    
    match /documentCounters/{yearId} {
      allow read: if signedIn();
      allow create, update: if signedIn();
      allow delete: if isAdmin();
    }

    match /purchaseDocs/{docId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if signedIn();
      allow delete: if isAdmin();
    }
    
    match /purchaseClaims/{claimId} {
        allow read, create, update: if isAccountingAllowed();
        allow delete: if isAdmin();
    }

    match /accountingAccounts/{id} {
      allow read, write: if isAccountingAllowed();
    }
    
    match /accountingEntries/{id} {
      allow read, create, update: if isAccountingAllowed();
      allow delete: if isMgmt();
    }
    
    match /accountingObligations/{id} {
      allow read, create, update: if signedIn();
      allow delete: if isMgmt();
    }
    
    match /billingRuns/{monthId} {
        allow read, write: if isAccountingAllowed();
    }

    match /attendance/{id} { allow read, write: if signedIn(); }
    match /kioskTokens/{id} {
      allow read, create, update: if true;
      allow delete: if isAdmin(); 
    }
    
    match /hrHolidays/{id} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }
    
    match /hrAttendanceAdjustments/{id} {
      allow read: if isMgmt();
      allow write: if isAdmin();
    }
    
    match /ssoHospitals/{hospitalId} {
      allow read: if signedIn();
      allow write: if isMgmt();
    }
    
    match /hrLeaves/{id} {
        allow read: if isMgmt() || (signedIn() && request.auth.uid == resource.data.userId);
        allow create: if signedIn();
        allow update: if isMgmt() || (signedIn() && request.auth.uid == resource.data.userId);
        allow delete: if isAdmin();
    }

    match /payrollBatches/{batchId} {
      allow read, write: if isMgmt();
      match /payslips/{userId} {
        allow read: if (signedIn() && request.auth.uid == userId) || isMgmt();
        allow write: if isMgmt() || (signedIn() && request.auth.uid == userId);
      }
    }
  }
}