rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===================================
    // Helper Functions
    // ===================================
    function signedIn() {
      return request.auth != null;
    }

    function userExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function getProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function role() {
      return userExists() ? getProfile().role : '';
    }
    function dept() {
      return userExists() ? getProfile().department : '';
    }
    
    function isAdmin() {
      return signedIn() && (role() == "ADMIN" || request.auth.token.email == "sahadiesel@gmail.com");
    }

    function isMgmt() {
      return isAdmin() || (signedIn() && dept() == "MANAGEMENT");
    }
    
    function isOfficeOrMgmt() {
      return isMgmt() || (signedIn() && dept() == "OFFICE");
    }
    
    function isAccountingAllowed() {
      return isMgmt();
    }

    // ===================================
    // Default Security Rules
    // ===================================
    match /{document=**} {
      allow read: if signedIn();
      allow write: if false; // Deny by default
    }

    // ===================================
    // Collection-Specific Rules
    // ===================================

    // User Profiles
    match /users/{uid} {
      allow read: if signedIn();
      // Allow updates if user is an admin OR if the user is editing their own profile.
      allow create, update: if isAdmin() || (signedIn() && request.auth.uid == uid);
      allow delete: if isAdmin();
    }

    // Settings
    match /settings/{docId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    // Customers & Vendors (MVP)
    match /customers/{id} {
      allow read: if signedIn();
      allow create, update: if signedIn();
      allow delete: if isAdmin();
    }
    match /vendors/{id} {
      allow read: if signedIn();
      allow create, update: if signedIn();
      allow delete: if isAdmin();
    }

    // Jobs & Main Documents (MVP)
    match /jobs/{jobId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if signedIn() && (isOfficeOrMgmt() || request.resource.data.photos == resource.data.photos);
      allow delete: if isAdmin();
      match /activities/{activityId} {
        allow read: if signedIn();
        allow create: if signedIn();
        allow update, delete: if isAdmin();
      }
    }
    match /documents/{docId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if 
         (
         (signedIn()
          && (resource.data.status in ['DRAFT', 'PENDING_REVIEW'])
          && request.resource.data.docNo == resource.data.docNo
         )
         || isAccountingAllowed()
         );
      allow delete: if isAdmin();
    }
    match /documentCounters/{yearId} {
      allow read: if signedIn();
      allow create, update: if signedIn();
      allow delete: if isAdmin();
    }

    // --- Purchase Workflow ---
    match /purchaseDocs/{docId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if (signedIn() && !(resource.data.status in ['PAID', 'CANCELLED'])) || isMgmt();
      allow delete: if isAdmin();
    }
    match /purchaseClaims/{claimId} {
        allow create: if signedIn();
        allow read, update: if isAccountingAllowed();
        allow delete: if isAdmin();
    }

    // --- Accounting Collections ---
    match /accountingAccounts/{id} {
      allow write: if isAccountingAllowed();
      allow read: if isAccountingAllowed();
      allow delete: if isAdmin();
    }
    match /accountingEntries/{id} {
      allow create: if isAccountingAllowed();
      allow read: if isAccountingAllowed();
      allow update, delete: if isAdmin();
    }
    match /accountingObligations/{id} {
      allow create: if signedIn(); 
      allow read: if signedIn();
      allow update: if isAccountingAllowed();
      allow delete: if isAdmin();
    }
    match /paymentClaims/{id} {
      allow create: if signedIn();
      allow read, update: if isAccountingAllowed();
      allow delete: if isAdmin();
    }

    // --- HR & Attendance (MVP) ---
    match /attendance/{id} { allow read, write: if signedIn(); }
    match /kioskTokens/{id} {
      allow read: if true;
      allow create: if true;
      allow update: if signedIn();
      allow delete: if false;
    }
    match /hrHolidays/{id} { allow read, write: if isMgmt(); }
    match /hrLeaves/{id} {
        allow read: if isMgmt() || request.auth.uid == resource.data.userId;
        allow create: if signedIn();
        allow update: if isMgmt() || (request.auth.uid == resource.data.userId && request.resource.data.status == 'CANCELLED');
    }
    match /hrAttendanceAdjustments/{id} { allow read, write: if isMgmt(); }
    match /payrollRuns/{runId}/{document=**} { allow read, write: if isMgmt(); }

    // Deprecated collections - lock them down
    match /userProfiles/{uid} { allow read, write: if false; }
    match /profiles/{uid} { allow read, write: if false; }
  }
}
