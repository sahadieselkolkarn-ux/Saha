rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===================================
    // Helper Functions
    // ===================================
    function signedIn() {
      return request.auth != null;
    }
    
    function isSystemAdmin() {
      return request.auth.uid == "oh3jF10Am4PPGelNzFhjWX6GE5E2";
    }

    function userExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function getProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function role() {
      return userExists() ? getProfile().role : '';
    }
    function dept() {
      return userExists() ? getProfile().department : '';
    }
    
    function isAdmin() {
      return isSystemAdmin() || (signedIn() && role() == "ADMIN");
    }

    function isMgmt() {
      return isSystemAdmin() || (signedIn() && (dept() == "MANAGEMENT" || role() == "ADMIN" || role() == "MANAGER"));
    }
    
    function isOfficeOrMgmt() {
      return isMgmt() || (signedIn() && dept() == "OFFICE");
    }
    
    function isAccountingAllowed() {
      // Allow access if user is in Office or has Management/Admin/Manager role
      return isOfficeOrMgmt();
    }
    
    function hrSettings() {
      return get(/databases/$(database)/documents/settings/hr).data;
    }
    
    function backfillMode() {
      return signedIn() && (hrSettings().backfillMode == true);
    }

    // ===================================
    // Default Security Rules
    // ===================================
    match /{document=**} {
      allow read: if signedIn();
      allow write: if false; // Deny by default
    }

    // ===================================
    // Collection-Specific Rules
    // ===================================

    // User Profiles
    match /users/{uid} {
      allow read: if signedIn();
      allow create, update: if isMgmt() || (signedIn() && request.auth.uid == uid);
      allow delete: if isAdmin();
    }

    // Settings
    match /settings/{docId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    // Cash Drawer
    match /cashDrawerSessions/{sessionId} {
      allow read: if signedIn();
      allow create: if isOfficeOrMgmt();
      allow update: if isOfficeOrMgmt();
      allow delete: if isAdmin();
      
      match /transactions/{transId} {
        allow read: if signedIn();
        allow create: if isOfficeOrMgmt();
        allow update, delete: if isMgmt();
      }
    }

    // Customers & Vendors
    match /customers/{id} {
      allow read: if signedIn();
      allow create, update: if signedIn();
      allow delete: if isAdmin();
    }
    match /vendors/{id} {
      allow read: if signedIn();
      allow create, update: if signedIn();
      allow delete: if isAdmin();
    }
    match /outsourceVendors/{id} {
      allow read: if signedIn();
      allow create, update: if isOfficeOrMgmt();
      allow delete: if isAdmin();
    }

    // Jobs & Main Documents
    match /jobs/{jobId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if signedIn() && (isOfficeOrMgmt() || request.resource.data.photos == resource.data.photos);
      allow delete: if isMgmt();
      match /activities/{activityId} {
        allow read: if signedIn();
        allow create: if signedIn();
        allow update, delete: if isMgmt();
      }
    }
    
    // Archive Collections (jobsArchive_2024, jobsArchive_2025, etc.)
    match /{collectionName}/{jobId} {
        allow read: if signedIn() && collectionName.startsWith('jobsArchive_');
        allow create, update, delete: if isMgmt() && collectionName.startsWith('jobsArchive_');
        match /activities/{activityId} {
            allow read: if signedIn() && collectionName.startsWith('jobsArchive_');
            allow write: if isMgmt() && collectionName.startsWith('jobsArchive_');
        }
    }

    match /documents/{docId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if 
         (
         (signedIn()
          && (resource.data.status in ['DRAFT', 'PENDING_REVIEW', 'APPROVED', 'UNPAID', 'PARTIAL'])
          && request.resource.data.docNo == resource.data.docNo
         )
         || isAccountingAllowed()
         );
      allow delete: if isAdmin();
    }
    match /documentCounters/{yearId} {
      allow read: if signedIn();
      allow create, update: if signedIn();
      allow delete: if isAdmin();
    }

    match /purchaseDocs/{docId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if (signedIn() && !(resource.data.status in ['PAID', 'CANCELLED'])) || isMgmt();
      allow delete: if isAdmin();
    }
    match /purchaseClaims/{claimId} {
        allow create: if signedIn();
        allow read, update: if isAccountingAllowed();
        allow delete: if isAdmin();
    }

    match /accountingAccounts/{id} {
      allow write: if isAccountingAllowed();
      allow read: if isAccountingAllowed();
      allow delete: if isAdmin();
    }
    match /accountingEntries/{id} {
      allow create: if isAccountingAllowed();
      allow read: if isAccountingAllowed();
      allow update, delete: if isMgmt();
    }
    match /accountingObligations/{id} {
      allow create: if signedIn(); 
      allow read: if signedIn();
      allow update: if isAccountingAllowed();
      allow delete: if isMgmt();
    }
    match /billingRuns/{monthId} {
        allow read, write: if isAccountingAllowed();
    }

    match /attendance/{id} { allow read, write: if signedIn(); }
    match /kioskTokens/{id} {
      allow read: if true;
      allow create: if true;
      allow update: if signedIn();
      allow delete: if isAdmin(); 
    }
    
    match /hrHolidays/{id} {
      allow read: if signedIn();
      allow create, update, delete: if isAdmin();
    }
    match /hrAttendanceAdjustments/{id} {
      allow read: if isMgmt();
      allow create, update, delete: if isAdmin();
    }
    match /ssoHospitals/{hospitalId} {
      allow read: if signedIn();
      allow write: if isMgmt();
    }
    match /hrLeaves/{id} {
        allow read: if isMgmt() || request.auth.uid == resource.data.userId;
        allow create: if signedIn() && (
          request.resource.data.userId == request.auth.uid
          || isAdmin()
        );
        allow update: if isAdmin()
          || isMgmt()
          || (request.auth.uid == resource.data.userId && request.resource.data.status == 'CANCELLED');
    }

    match /payrollBatches/{batchId} {
      allow read, write: if isMgmt();
      match /payslips/{userId} {
        allow read: if (signedIn() && request.auth.uid == userId) || isMgmt();
        allow create, delete: if isMgmt();
        allow update: if 
          (
            request.auth.uid == userId &&
            resource.data.status == 'SENT_TO_EMPLOYEE' &&
            request.resource.data.status in ['READY_TO_PAY', 'REVISION_REQUESTED'] &&
            request.resource.data.snapshot == resource.data.snapshot
          ) ||
          (
            isMgmt() &&
            resource.data.status in ['DRAFT', 'REVISION_REQUESTED']
          ) ||
          (
            isAccountingAllowed() &&
            resource.data.status == 'READY_TO_PAY' &&
            request.resource.data.status == 'PAID' &&
            request.resource.data.snapshot == resource.data.snapshot
          );
      }
    }
  }
}
