
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===================================
    // Helper Functions
    // ===================================
    function signedIn() {
      return request.auth != null;
    }
    
    function isSystemAdmin() {
      return request.auth.uid == "oh3jF10Am4PPGelNzFhjWX6GE5E2";
    }

    function userExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function getProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function role() {
      return userExists() ? getProfile().role : '';
    }
    function dept() {
      return userExists() ? getProfile().department : '';
    }
    
    function isAdmin() {
      return isSystemAdmin() || (signedIn() && role() == "ADMIN");
    }

    function isMgmt() {
      return isSystemAdmin() || (signedIn() && dept() == "MANAGEMENT") || role() == "ADMIN";
    }
    
    function isOfficeOrMgmt() {
      return isMgmt() || (signedIn() && dept() == "OFFICE");
    }
    
    function isAccountingAllowed() {
      return isSystemAdmin() || isMgmt();
    }

    // ===================================
    // Default Security Rules
    // ===================================
    match /{document=**} {
      allow read: if signedIn();
      allow write: if false; // Deny by default
    }

    // ===================================
    // Collection-Specific Rules
    // ===================================

    // User Profiles
    match /users/{uid} {
      allow read: if signedIn();
      // Allow updates if user is admin/mgmt OR if the user is editing their own profile.
      allow create, update: if isMgmt() || (signedIn() && request.auth.uid == uid);
      allow delete: if isAdmin();
    }

    // Settings
    match /settings/{docId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    // Customers & Vendors (MVP)
    match /customers/{id} {
      allow read: if signedIn();
      allow create, update: if signedIn();
      allow delete: if isAdmin();
    }
    match /vendors/{id} {
      allow read: if signedIn();
      allow create, update: if signedIn();
      allow delete: if isAdmin();
    }

    // Jobs & Main Documents (MVP)
    match /jobs/{jobId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if signedIn() && (isOfficeOrMgmt() || request.resource.data.photos == resource.data.photos);
      allow delete: if isAdmin();
      match /activities/{activityId} {
        allow read: if signedIn();
        allow create: if signedIn();
        allow update, delete: if isAdmin();
      }
    }
    
    match /jobsArchive_{year}/{jobId} {
        allow read: if signedIn();
        allow create, update, delete: if isAdmin(); // Only allow admins to modify archives
        match /activities/{activityId} {
            allow read: if signedIn();
            allow write: if isAdmin();
        }
    }

    match /documents/{docId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if 
         (
         (signedIn()
          && (resource.data.status in ['DRAFT', 'PENDING_REVIEW'])
          && request.resource.data.docNo == resource.data.docNo
         )
         || isAccountingAllowed()
         );
      allow delete: if isAdmin();
    }
    match /documentCounters/{yearId} {
      allow read: if signedIn();
      allow create, update: if signedIn();
      allow delete: if isAdmin();
    }

    // --- Purchase Workflow ---
    match /purchaseDocs/{docId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if (signedIn() && !(resource.data.status in ['PAID', 'CANCELLED'])) || isMgmt();
      allow delete: if isAdmin();
    }
    match /purchaseClaims/{claimId} {
        allow create: if signedIn();
        allow read, update: if isAccountingAllowed();
        allow delete: if isAdmin();
    }

    // --- Accounting Collections ---
    match /accountingAccounts/{id} {
      allow write: if isAccountingAllowed();
      allow read: if isAccountingAllowed();
      allow delete: if isAdmin();
    }
    match /accountingEntries/{id} {
      allow create: if isAccountingAllowed();
      allow read: if isAccountingAllowed();
      allow update, delete: if isAdmin();
    }
    match /accountingObligations/{id} {
      allow create: if signedIn(); 
      allow read: if signedIn();
      allow update: if isAccountingAllowed();
      allow delete: if isAdmin();
    }
    match /paymentClaims/{id} {
      allow create: if signedIn();
      allow read, update: if isAccountingAllowed();
      allow delete: if isAdmin();
    }

    // --- HR & Attendance (MVP) ---
    match /attendance/{id} { allow read, write: if signedIn(); }
    match /kioskTokens/{id} {
      allow read: if true;
      allow create: if true;
      allow update: if signedIn();
      allow delete: if false;
    }
    match /hrHolidays/{id} { allow read, write: if isMgmt(); }
    match /ssoHospitals/{hospitalId} {
      allow read: if signedIn();
      allow write: if isMgmt();
    }
    match /hrLeaves/{id} {
        allow read: if isMgmt() || request.auth.uid == resource.data.userId;
        allow create: if signedIn();
        allow update: if isMgmt() || (request.auth.uid == resource.data.userId && request.resource.data.status == 'CANCELLED');
    }
    match /hrAttendanceAdjustments/{id} { allow read, write: if isMgmt(); }

    match /payrollBatches/{batchId} {
      allow read, write: if isMgmt();

      match /payslips/{userId} {
        // employee can read their own payslip
        allow read: if (signedIn() && request.auth.uid == userId) || isMgmt();
        
        // HR/Management can create/delete payslips
        allow create, delete: if isMgmt();

        allow update: if 
          // Case 1: Employee accepts or requests revision.
          (
            request.auth.uid == userId &&
            resource.data.status == 'SENT_TO_EMPLOYEE' &&
            request.resource.data.status in ['READY_TO_PAY', 'REVISION_REQUESTED'] &&
            request.resource.data.snapshot == resource.data.snapshot // Cannot change snapshot
          ) ||
          // Case 2: Management/HR edits a draft or a revision request.
          (
            isMgmt() &&
            resource.data.status in ['DRAFT', 'REVISION_REQUESTED']
          ) ||
          // Case 3: Accounting marks as paid.
          (
            isAccountingAllowed() &&
            resource.data.status == 'READY_TO_PAY' &&
            request.resource.data.status == 'PAID' &&
            request.resource.data.snapshot == resource.data.snapshot // Cannot change snapshot
          );
      }
    }

    // Deprecated collections - lock them down
    match /userProfiles/{uid} { allow read, write: if false; }
    match /profiles/{uid} { allow read, write: if false; }
  }
}
