rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    // System admin fallback (กันล็อกตัวเอง)
    function isSystemAdmin() {
      return signedIn() && request.auth.token.email == "sahadieselkolkarn@gmail.com";
    }

    // Get user role and department from the /users collection
    function roleFromProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    function deptFromProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.department;
    }

    function role() { return request.auth.token.role != null ? request.auth.token.role : roleFromProfile(); }
    function dept() { return request.auth.token.department != null ? request.auth.token.department : deptFromProfile(); }

    function isAdmin() { return isSystemAdmin() || (signedIn() && role() == "ADMIN"); }
    function isMgmt()  { return isAdmin() || (signedIn() && dept() == "MANAGEMENT"); }
    
    // Helper function for accounting permissions
    function isAccountingAllowed() {
      return isAdmin() || isMgmt();
    }

    // -------------------------
    // Default: readable (signed-in), writable: deny
    // This rule secures the database by default. Specific write rules must be explicitly defined below.
    // -------------------------
    match /{document=**} {
      allow read: if signedIn();
      allow write: if false;
    }

    // -------------------------
    // Profiles - Users can edit their own profiles. Admins can edit any.
    // -------------------------
    match /users/{uid} {
      allow read: if signedIn();
      allow create, update: if isAdmin() || (signedIn() && request.auth.uid == uid);
      allow delete: if isAdmin();
    }
     match /userProfiles/{uid} {
      allow read: if signedIn();
      allow create, update: if isAdmin() || (signedIn() && request.auth.uid == uid);
      allow delete: if isAdmin();
    }
    match /profiles/{uid} {
      allow read: if signedIn();
      allow create, update: if isAdmin() || (signedIn() && request.auth.uid == uid);
      allow delete: if isAdmin();
    }

    // -------------------------
    // Settings - Only Admins can change application-wide settings.
    // -------------------------
    match /settings/{docId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    // -------------------------
    // Customers / Vendors
    // -------------------------
    match /customers/{id} {
      allow read: if signedIn();
      allow create, update: if isAdmin() || isMgmt() || (signedIn() && dept() == "OFFICE");
      allow delete: if isAdmin();
    }
    match /vendors/{id} {
      allow read: if signedIn();
      allow create, update: if isAdmin() || isMgmt() || (signedIn() && dept() == "OFFICE");
      allow delete: if isAdmin();
    }

    // -------------------------
    // Jobs + subcollection activities
    // Any signed-in user can create/update jobs and activities to maintain workflow integrity.
    // -------------------------
    match /jobs/{jobId} {
      allow read: if signedIn();
      allow create, update: if signedIn();
      allow delete: if isAdmin();

      match /activities/{activityId} {
        allow read: if signedIn();
        allow create: if signedIn();
        allow update, delete: if isAdmin();
      }
    }

    // -------------------------
    // Documents + Counters
    // -------------------------
    match /documents/{docId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update: if (
        (resource.data.status == "DRAFT" && request.resource.data.docNo == resource.data.docNo)
        || isAccountingAllowed()
      );
      allow delete: if isAdmin();
    }

    match /documentCounters/{yearId} {
      allow read, create, update: if signedIn();
      allow delete: if isAdmin();
    }
    
    // -------------------------
    // Payment Claims (รอตรวจสอบรายรับ)
    // -------------------------
    match /paymentClaims/{id} {
      allow read: if isAccountingAllowed();
      allow create: if signedIn();
      allow update: if isAccountingAllowed();
      allow delete: if isAdmin();
    }

    // -------------------------
    // Accounting (แกนบัญชี)
    // -------------------------
    match /accountingAccounts/{id} {
      allow read, write: if isAccountingAllowed();
      allow delete: if isAdmin();
    }

    match /accountingEntries/{id} {
      allow read, create: if isAccountingAllowed();
      allow update, delete: if isAdmin(); // immutable for data integrity. Only Admins can override.
    }

    match /accountingObligations/{id} {
      allow read, write: if isAccountingAllowed();
      allow delete: if isAdmin();
    }
    
    // -------------------------
    // HR collections
    // -------------------------
    match /hrHolidays/{holidayId} {
      allow read: if signedIn();
      allow write: if isMgmt();
    }
    
    match /hrLeaves/{leaveId} {
      allow read: if signedIn();
      allow create: if request.auth.uid == request.resource.data.userId;
      allow update: if isMgmt() || (request.auth.uid == resource.data.userId && request.resource.data.status == "CANCELLED");
    }
    
    match /hrAttendanceAdjustments/{adjustmentId} {
      allow read: if signedIn();
      allow write: if isMgmt();
    }
    
    match /payrollRuns/{runId} {
      allow read, write: if isMgmt();
      match /payslips/{payslipId} {
        allow read: if isMgmt() || request.auth.uid == payslipId;
        allow write: if isMgmt() || (request.auth.uid == payslipId && request.resource.data.employeeStatus != resource.data.employeeStatus);
      }
    }
    
    // -------------------------
    // Attendance and Kiosk tokens
    // -------------------------
    match /attendance/{attendanceId} {
        allow read: if signedIn();
        allow create: if signedIn();
        allow write: if isMgmt();
    }
    
    match /kioskTokens/{tokenId} {
        allow read, write: if signedIn();
    }
  }
}