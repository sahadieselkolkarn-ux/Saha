rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    // System admin fallback (กันล็อกตัวเอง)
    function isSystemAdmin() {
      return signedIn() && request.auth.token.email == "sahadieselkolkarn@gmail.com";
    }

    // Try custom claims first; fallback to common profile collections.
    function roleFromProfile() {
      return
        exists(/databases/$(database)/documents/userProfiles/$(request.auth.uid)) ? get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.role :
        exists(/databases/$(database)/documents/profiles/$(request.auth.uid)) ? get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role :
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role :
        null;
    }

    function deptFromProfile() {
      return
        exists(/databases/$(database)/documents/userProfiles/$(request.auth.uid)) ? get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.department :
        exists(/databases/$(database)/documents/profiles/$(request.auth.uid)) ? get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.department :
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.department :
        null;
    }

    function role() { return request.auth.token.role != null ? request.auth.token.role : roleFromProfile(); }
    function dept() { return request.auth.token.department != null ? request.auth.token.department : deptFromProfile(); }

    function isAdmin() { return isSystemAdmin() || (signedIn() && role() == "ADMIN"); }
    function isMgmt()  { return isAdmin() || (signedIn() && dept() == "MANAGEMENT"); }

    // ปรับชื่อแผนกการเงินให้ตรง constants ของโปรเจค ถ้ายังไม่มี ให้ MANAGEMENT ทำหน้าที่แทนไปก่อน
    function isFinance() {
      return isAdmin() || isMgmt() || (signedIn() && (dept() == "FINANCE" || dept() == "ACCOUNTING"));
    }

    // -------------------------
    // Default: readable (signed-in), writable: deny
    // -------------------------
    match /{document=**} {
      allow read: if signedIn();
      allow write: if false;
    }

    // -------------------------
    // Profiles (ถ้ามีใช้)
    // -------------------------
    match /userProfiles/{uid} {
      allow read: if signedIn();
      allow create, update: if isAdmin() || (signedIn() && request.auth.uid == uid);
      allow delete: if isAdmin();
    }
    match /profiles/{uid} {
      allow read: if signedIn();
      allow create, update: if isAdmin() || (signedIn() && request.auth.uid == uid);
      allow delete: if isAdmin();
    }
    match /users/{uid} {
      allow read: if signedIn();
      allow create, update: if isAdmin() || (signedIn() && request.auth.uid == uid);
      allow delete: if isAdmin();
    }

    // -------------------------
    // Settings
    // -------------------------
    match /settings/{docId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    // -------------------------
    // Customers / Vendors (ให้ระบบใช้งานทั่วไปไม่พัง)
    // -------------------------
    match /customers/{id} {
      allow read: if signedIn();
      allow create, update: if isAdmin() || isMgmt();
      allow delete: if isAdmin();
    }
    match /vendors/{id} {
      allow read: if signedIn();
      allow create, update: if isAdmin() || isMgmt();
      allow delete: if isAdmin();
    }

    // -------------------------
    // Jobs + subcollection activities
    // (ยังเปิดให้ signed-in เขียนได้ เพื่อไม่ให้ flow งานซ่อมพังในระหว่างปรับบัญชี)
    // -------------------------
    match /jobs/{jobId} {
      allow read: if signedIn();
      allow create, update: if signedIn();
      allow delete: if isAdmin();

      match /activities/{activityId} {
        allow read: if signedIn();
        allow create: if signedIn();
        allow update, delete: if isAdmin();
      }
    }

    // -------------------------
    // Documents + Counters
    // -------------------------
    match /documents/{docId} {
      allow read: if signedIn();

      // สร้างเอกสารได้: ออฟฟิศ/บริหาร/แอดมิน (MVP)
      allow create: if signedIn();

      // แก้ไขเอกสาร:
      // - ถ้าเป็น draft ใครสร้างก็แก้ได้ (MVP) แต่ "ห้ามแก้ docNo"
      // - สถานะ PAID/ฟิลด์การเงิน: เฉพาะ finance
      allow update: if (
        (resource.data.status == "DRAFT" && request.resource.data.docNo == resource.data.docNo)
        || isFinance()
      );

      allow delete: if isAdmin();
    }

    match /documentCounters/{yearId} {
      allow read: if signedIn();
      // allow เฉพาะเพื่อออกเลขเอกสาร (ใช้ใน transaction createDocument)
      allow create, update: if signedIn();
      allow delete: if isAdmin();
    }

    // -------------------------
    // Payment Claims (รอตรวจสอบรายรับ)
    // -------------------------
    match /paymentClaims/{id} {
      allow read: if isFinance();

      // ผู้แจ้งรับเงิน (ออฟฟิศ) สร้างได้
      allow create: if signedIn();

      // อนุมัติ/ตีกลับ/แก้ข้อมูลรับเงิน: เฉพาะ finance
      allow update: if isFinance();

      allow delete: if isAdmin();
    }

    // -------------------------
    // Accounting (แกนบัญชี)
    // -------------------------
    match /accountingAccounts/{id} {
      allow read: if isFinance();
      allow create, update: if isFinance();
      allow delete: if isAdmin();
    }

    match /accountingEntries/{id} {
      allow read: if isFinance();
      allow create: if isFinance();
      // immutable สำหรับคนทั่วไป
      allow update, delete: if isAdmin();
    }

    match /accountingObligations/{id} {
      allow read: if isFinance();
      allow create, update: if isFinance();
      allow delete: if isAdmin();
    }
  }
}